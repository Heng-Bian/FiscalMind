# FiscalMind

é¢å‘è´¢åŠ¡BPçš„è¡¨æ ¼åˆ†æAgent - A Table Analysis Agent for Financial Business Partners

## ç®€ä»‹ (Introduction)

FiscalMind æ˜¯ä¸€ä¸ªåŸºäº LangGraph æ¡†æ¶çš„æ™ºèƒ½è¡¨æ ¼æ–‡æ¡£åˆ†æç³»ç»Ÿï¼Œä¸“ä¸ºè´¢åŠ¡BPè®¾è®¡ã€‚å®ƒèƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªExcelæ–‡æ¡£ï¼Œæä¾›æ™ºèƒ½çš„æ•°æ®åˆ†æå’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚

FiscalMind is an intelligent table document analysis system built on the LangGraph framework, designed for financial business partners. It can process multiple Excel documents simultaneously and provide intelligent data analysis and query capabilities.

## ä¸»è¦åŠŸèƒ½ (Key Features)

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å¤šæ–‡æ¡£æ”¯æŒ**: åŒæ—¶åŠ è½½å’Œå¤„ç†å¤šä¸ªExcelæ–‡æ¡£
- âœ… **æ™ºèƒ½è§£æ**: è‡ªåŠ¨è§£æExcelæ–‡ä»¶ç»“æ„å’Œå†…å®¹
- âœ… **LangGraphé›†æˆ**: åŸºäºLangGraphçš„æ™ºèƒ½å·¥ä½œæµ
- âœ… **äº¤äº’å¼æŸ¥è¯¢**: æ”¯æŒè‡ªç„¶è¯­è¨€å¼çš„äº¤äº’æŸ¥è¯¢
- âœ… **è´¢åŠ¡ä¸“ç”¨**: é’ˆå¯¹è´¢åŠ¡åœºæ™¯ä¼˜åŒ–çš„åŠŸèƒ½è®¾è®¡

### ğŸ†• å¢å¼ºåŠŸèƒ½ (v2.0)
- âœ… **é«˜çº§è¿‡æ»¤**: æ”¯æŒ >, <, >=, <=, between, in, contains ç­‰æ“ä½œç¬¦
- âœ… **å¤šåˆ—æ’åº**: æ”¯æŒå•åˆ—æˆ–å¤šåˆ—ç»„åˆæ’åº
- âœ… **è¡¨å…³è”**: æ”¯æŒè·¨æ–‡æ¡£çš„ inner/left/right/outer join
- âœ… **è¯­ä¹‰æœç´¢**: æ™ºèƒ½åˆ—åæŸ¥æ‰¾ï¼Œæ”¯æŒåŒä¹‰è¯åŒ¹é…
- âœ… **è‡ªåŠ¨åˆ†ç»„**: è‡ªåŠ¨è¯†åˆ«ç»´åº¦åˆ—å’Œåº¦é‡åˆ—ï¼Œæ™ºèƒ½åˆ†ç»„èšåˆ
- âœ… **æ•°æ®è´¨é‡åˆ†æ**: ç¼ºå¤±å€¼ã€å¼‚å¸¸å€¼åˆ†æåŠæ¸…æ´—å»ºè®®
- âœ… **Function Calling**: åŸºäºLLMå·¥å…·å†…çœçš„æ™ºèƒ½Agent
- âœ… **å¤šæ­¥æ¨ç†**: æ”¯æŒé“¾å¼è°ƒç”¨å¤šä¸ªå·¥å…·å®Œæˆå¤æ‚ä»»åŠ¡

### ğŸ†• å¤šè¡¨æ ¼æ£€æµ‹ (v2.1)
- âœ… **å¤šè¡¨æ ¼è§£æ**: è‡ªåŠ¨æ£€æµ‹å•ä¸ªsheetä¸­çš„å¤šä¸ªè¡¨æ ¼
- âœ… **è¡¨æ ¼åç§»è¯†åˆ«**: æ”¯æŒä¸ä»A1å¼€å§‹çš„è¡¨æ ¼
- âœ… **æè¿°æå–**: è‡ªåŠ¨æå–è¡¨æ ¼é™„è¿‘çš„æè¿°æ–‡æœ¬
- âœ… **é»˜è®¤å¯ç”¨**: ç°å·²é»˜è®¤å¼€å¯ï¼Œè‡ªåŠ¨æä¾›æ›´å¼ºå¤§çš„è¡¨æ ¼æ£€æµ‹èƒ½åŠ›

### ğŸ†• LLMæ™ºèƒ½è¡¨å¤´æ£€æµ‹ (v3.1)
- âœ… **æ™ºèƒ½è¡¨å¤´è¯†åˆ«**: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹å‡†ç¡®è¯†åˆ«è¡¨å¤´ï¼Œé¿å…å°†æ•°æ®è¡Œè¯¯åˆ¤ä¸ºè¡¨å¤´
- âœ… **å¤šè¡Œè¡¨å¤´æ”¯æŒ**: æ™ºèƒ½å¤„ç†å¤šå±‚è¡¨å¤´ç»“æ„
- âœ… **é«˜ç½®ä¿¡åº¦æ£€æµ‹**: æä¾›ç½®ä¿¡åº¦è¯„åˆ†ï¼Œä½ç½®ä¿¡åº¦æ—¶è‡ªåŠ¨fallbackåˆ°è§„åˆ™æ–¹æ³•
- âœ… **é»˜è®¤å¯ç”¨**: å½“æä¾›LLMæ—¶è‡ªåŠ¨ä½¿ç”¨ï¼Œæœªæä¾›æ—¶ä½¿ç”¨è§„åˆ™æ–¹æ³•

### ğŸ†• æ™ºèƒ½è¯­ä¹‰åŒ¹é… (v2.2)
- âœ… **å·¥ä½œè¡¨è¯­ä¹‰åŒ¹é…**: è‡ªåŠ¨è¯†åˆ«"24å¹´é¢„ç®—" â†’ "FY24_Budget"
- âœ… **åˆ—åæ™ºèƒ½åŒ¹é…**: "è–ªèµ„" â†’ "æœˆè–ª", "è¥æ”¶" â†’ "é”€å”®é¢"
- âœ… **å…³è”é”®è‡ªåŠ¨å‘ç°**: æ™ºèƒ½è¯†åˆ«"å‘˜å·¥ç¼–å·" â†” "å·¥å·"
- âœ… **æŸ¥è¯¢æ„å›¾è¯†åˆ«**: LLMå¢å¼ºçš„è‡ªç„¶è¯­è¨€ç†è§£
- âœ… **å€¼æ¨¡ç³ŠåŒ¹é…**: "åŒ—äº¬" = "åŒ—äº¬å¸‚" = "Beijing"
- âœ… **æ–‡æ¡£åæ™ºèƒ½å®šä½**: "æŠ¥é”€å•" â†’ "reimbursement_v2.xlsx"
- âœ… **LLMä¿åº•æœºåˆ¶**: é«˜å¯ä¿¡åº¦çš„è¯­ä¹‰åŒ¹é…

### ğŸ†• Plan-ReAct-Reflectæ¶æ„ (v3.0)
- âœ… **æ™ºèƒ½è§„åˆ’**: è‡ªåŠ¨å°†å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¯æ‰§è¡Œæ­¥éª¤
- âœ… **æ¨ç†è¡ŒåŠ¨**: åŸºäºè®¡åˆ’æ‰§è¡Œæ¨ç†å’Œå·¥å…·è°ƒç”¨
- âœ… **è‡ªæˆ‘åæ€**: è¯„ä¼°æ‰§è¡Œè¿›åº¦ï¼ŒåŠ¨æ€è°ƒæ•´ç­–ç•¥
- âœ… **åŒºåŸŸå¯¹æ¯”**: æ™ºèƒ½å›ç­”"å“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½"ç±»é—®é¢˜
- âœ… **å¤šç»´åˆ†æ**: æ”¯æŒé”€å”®é¢ã€åˆ©æ¶¦ç‡ç­‰å¤šç»´åº¦å¯¹æ¯”
- âœ… **è¿­ä»£ä¼˜åŒ–**: é€šè¿‡åæ€æœºåˆ¶æŒç»­ä¼˜åŒ–åˆ†æè¿‡ç¨‹

### ğŸ†• ä¸“ä¸šæ™ºèƒ½ä½“æ¶æ„ (v3.0)
- âœ… **ä¸šåŠ¡åˆ†ææ™ºèƒ½ä½“**: æ·±å…¥ç†è§£æ•°æ®èƒŒåçš„ä¸šåŠ¡é€»è¾‘å’Œåœºæ™¯
- âœ… **æ‰¹è¯„è€…æ™ºèƒ½ä½“**: è¯„ä¼°åˆ†æè´¨é‡ï¼Œç¡®ä¿ä¸é—®é¢˜åŒ¹é…
- âœ… **è¯„åˆ¤æ™ºèƒ½ä½“**: éªŒè¯ç»“è®ºçš„åˆç†æ€§å’Œæ•°æ®æ”¯æ’‘
- âœ… **å¤šè½®åä½œ**: æ™ºèƒ½ä½“ä¹‹é—´å¯è¿›è¡Œå¤šè½®åä½œä¼˜åŒ–
- âœ… **è´¨é‡ä¿è¯**: ä»ä¸šåŠ¡é€»è¾‘ã€æ•°æ®æ”¯æ’‘ç­‰å¤šç»´åº¦è¯„ä¼°
- âœ… **æ·±åº¦æ€è€ƒ**: AIæ€è€ƒè¿‡ç¨‹æ›´åŠ ç³»ç»ŸåŒ–å’Œä¸“ä¸šåŒ–

è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹: [æ–°åŠŸèƒ½æ–‡æ¡£](docs/NEW_FEATURES.md) | [å¤šè¡¨æ ¼æ£€æµ‹æ–‡æ¡£](docs/MULTI_TABLE_DETECTION.md) | [è¯­ä¹‰åŒ¹é…æ–‡æ¡£](docs/SEMANTIC_MATCHING.md) | [ä¸“ä¸šæ™ºèƒ½ä½“æ–‡æ¡£](docs/SPECIALIZED_AGENTS.md) | [LLMè¡¨å¤´æ£€æµ‹æ–‡æ¡£](docs/LLM_HEADER_DETECTION.md)

## âš ï¸ é‡è¦å˜æ›´è¯´æ˜ (Important Changes)

**å¤šè¡¨æ ¼æ£€æµ‹ç°å·²é»˜è®¤å¯ç”¨**: ä»æ­¤ç‰ˆæœ¬å¼€å§‹ï¼Œ`ExcelDocument` çš„ `detect_multiple_tables` å‚æ•°é»˜è®¤å€¼å·²ä» `False` æ”¹ä¸º `True`ï¼Œä»¥å¯ç”¨æ›´å¼ºå¤§çš„LLMç›¸å…³æœºåˆ¶ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹å¹¶è§£æsheetä¸­çš„å¤šä¸ªè¡¨æ ¼ã€è¯†åˆ«è¡¨æ ¼åç§»ã€æå–æè¿°ç­‰ã€‚

**å¦‚æœæ‚¨éœ€è¦ä¿æŒæ—§ç‰ˆæœ¬è¡Œä¸º**: å¦‚æœæ‚¨çš„ç°æœ‰ä»£ç ä¾èµ–äºç®€å•çš„ `pd.read_excel()` è¡Œä¸ºï¼Œè¯·åœ¨å‡çº§åæ˜¾å¼è®¾ç½® `detect_multiple_tables=False`:

```python
# æ–¹å¼1: åœ¨ExcelParserçº§åˆ«ç¦ç”¨
parser = ExcelParser(detect_multiple_tables=False)

# æ–¹å¼2: åœ¨åŠ è½½å•ä¸ªæ–‡æ¡£æ—¶ç¦ç”¨
doc = parser.load_document('file.xlsx', detect_multiple_tables=False)

# æ–¹å¼3: ç›´æ¥ä½¿ç”¨ExcelDocumentæ—¶ç¦ç”¨
from fiscal_mind.parser import ExcelDocument
doc = ExcelDocument('file.xlsx', detect_multiple_tables=False)
```

**ä¸ºä»€ä¹ˆåšè¿™ä¸ªå˜æ›´**: è¿™ä¸ªå˜æ›´ä½¿ç³»ç»Ÿé»˜è®¤æä¾›æ›´æ™ºèƒ½çš„è¡¨æ ¼æ£€æµ‹èƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯LLMå¢å¼ºçš„è¡¨å¤´è¯†åˆ«ï¼Œè®©ç”¨æˆ·æ— éœ€é¢å¤–é…ç½®å³å¯è·å¾—æœ€ä½³ä½“éªŒã€‚


## æŠ€æœ¯æ ˆ (Tech Stack)

- **Python 3.8+**
- **LangGraph**: æ™ºèƒ½ä½“å·¥ä½œæµæ¡†æ¶
- **Pandas**: æ•°æ®å¤„ç†å’Œåˆ†æ
- **OpenPyXL**: Excelæ–‡ä»¶è¯»å†™
- **LangChain**: LLMé›†æˆï¼ˆå¯é€‰ï¼‰

## å®‰è£… (Installation)

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/Heng-Bian/FiscalMind.git
cd FiscalMind

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

## å¿«é€Ÿå¼€å§‹ (Quick Start)

### æœ€ç®€å•çš„æ–¹å¼ - ä½¿ç”¨ä¸»ç¨‹åº (Recommended)

```bash
# 1. å°†æ‚¨çš„Excelæ–‡ä»¶æ”¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•
cp your_data.xlsx ./

# 2. è¿è¡Œä¸»ç¨‹åºï¼ˆè‡ªåŠ¨åŠ è½½å½“å‰ç›®å½•æ‰€æœ‰Excelæ–‡ä»¶ï¼‰
python main.py
```

ç¨‹åºä¼šè‡ªåŠ¨ï¼š
- ğŸ” æ‰«æå¹¶åŠ è½½å½“å‰ç›®å½•çš„æ‰€æœ‰Excelæ–‡ä»¶
- ğŸ¤– å¯åŠ¨PRR Agent (Plan-ReAct-Reflect) è¿›è¡Œæ™ºèƒ½åˆ†æ
- ğŸ’¬ è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œå¯ä»¥æé—®å¦‚"å“ªä¸ªå¤§åŒºè¡¨ç°æ›´å¥½ï¼Ÿ"

**ç¤ºä¾‹å¯¹è¯:**
```
FiscalMind> å“ªä¸ªå¤§åŒºè¡¨ç°æ›´å¥½ï¼Ÿ
æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...

å›ç­”:
é—®é¢˜: å“ªä¸ªå¤§åŒºè¡¨ç°æ›´å¥½?
åˆ†æç»“æœ:
1. è¯†åˆ«åŒ…å«åŒºåŸŸ(å¤§åŒº)æ•°æ®çš„å·¥ä½œè¡¨
2. æå–å„ä¸ªåŒºåŸŸçš„å…³é”®ä¸šç»©æŒ‡æ ‡(å¦‚é”€å”®é¢ã€åˆ©æ¶¦ç­‰)
3. æ¯”è¾ƒå„åŒºåŸŸçš„è¡¨ç°

ç»“è®º: æ ¹æ®åˆ†æï¼Œåä¸œå¤§åŒºè¡¨ç°æœ€ä½³ã€‚
```

### 1. åˆ›å»ºç¤ºä¾‹Excelæ–‡ä»¶

```bash
# ç”Ÿæˆç¤ºä¾‹æ•°æ®
python examples/create_samples.py
```

è¿™å°†åˆ›å»ºä¸‰ä¸ªç¤ºä¾‹Excelæ–‡ä»¶ï¼š
- `financial_report.xlsx` - è´¢åŠ¡æŠ¥è¡¨
- `sales_data.xlsx` - é”€å”®æ•°æ®
- `employee_salary.xlsx` - å‘˜å·¥è–ªèµ„

### 2. åŸºç¡€ä½¿ç”¨ï¼ˆé€šè¿‡Python APIï¼‰

```python
from fiscal_mind.agent import TableDocumentAgent

# åˆ›å»ºAgent
agent = TableDocumentAgent()

# åŠ è½½Excelæ–‡æ¡£
agent.load_documents([
    'examples/financial_report.xlsx',
    'examples/sales_data.xlsx'
])

# è·å–æ–‡æ¡£æ‘˜è¦
summary = agent.get_document_summary()
print(summary)

# æŸ¥è¯¢åˆ†æ
response = agent.query("æ˜¾ç¤ºæ‰€æœ‰æ–‡æ¡£çš„ç»Ÿè®¡ä¿¡æ¯")
print(response)
```

### 3. ä½¿ç”¨PRR Agentè¿›è¡Œä¸“ä¸šè´¢åŠ¡åˆ†æ

```python
from fiscal_mind.prr_agent import PRRAgent

# åˆ›å»ºPRR Agent (ä¸“ä¸ºè´¢åŠ¡BPè®¾è®¡)
agent = PRRAgent()

# åŠ è½½æ–‡æ¡£
agent.load_documents(['regional_performance.xlsx'])

# æé—®å¤æ‚çš„åˆ†æé—®é¢˜
answer = agent.query("å“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½ï¼Ÿ")
print(answer)
```

### 4. æ—§ç‰ˆäº¤äº’æ¨¡å¼ï¼ˆå·²è¿‡æ—¶ï¼‰

```bash
# å¯åŠ¨äº¤äº’å¼ç•Œé¢
python -m fiscal_mind.main examples/*.xlsx -i
```

**æ³¨æ„**: æ¨èä½¿ç”¨æ–°çš„ `python main.py`ï¼Œå®ƒä¼šè‡ªåŠ¨åŠ è½½å½“å‰ç›®å½•çš„Excelæ–‡ä»¶ã€‚

## æ ¸å¿ƒæ¨¡å—è¯´æ˜ (Core Modules)

### 1. Parser æ¨¡å— (`fiscal_mind/parser.py`)

Excelæ–‡æ¡£è§£æå™¨ï¼Œè´Ÿè´£è¯»å–å’Œè§£æExcelæ–‡ä»¶ã€‚

**ä¸»è¦ç±»:**
- `ExcelDocument`: è¡¨ç¤ºå•ä¸ªExcelæ–‡æ¡£
- `ExcelParser`: ç®¡ç†å¤šä¸ªExcelæ–‡æ¡£

**ä¸»è¦åŠŸèƒ½:**
- è¯»å–æ‰€æœ‰å·¥ä½œè¡¨
- è·å–æ–‡æ¡£æ‘˜è¦
- æ•°æ®æœç´¢
- åˆ—æå–
- è¡Œè¿‡æ»¤

### 2. Meta Functions æ¨¡å— (`fiscal_mind/meta_functions.py`)

æä¾›è¡¨æ ¼æ•°æ®çš„å…ƒæ“ä½œå’ŒLLMäº¤äº’å·¥å…·ã€‚

**ä¸»è¦ç±»:**
- `TableMetaFunctions`: è¡¨æ ¼å…ƒåŠŸèƒ½ï¼ˆç»Ÿè®¡ã€æ‘˜è¦ã€æ ¼å¼åŒ–ï¼‰
- `TableQueryHelper`: æŸ¥è¯¢è¾…åŠ©å·¥å…·ï¼ˆèšåˆã€è¿‡æ»¤ã€æ’åºï¼‰

**ä¸»è¦åŠŸèƒ½:**
- è¡¨æ ¼ç»“æ„åˆ†æ
- ç»Ÿè®¡ä¿¡æ¯æå–
- LLMä¸Šä¸‹æ–‡æ ¼å¼åŒ–
- æ•°æ®èšåˆå’Œé€è§†

### 3. Agent æ¨¡å— (`fiscal_mind/agent.py`)

åŸºäºLangGraphçš„æ™ºèƒ½Agentã€‚

**ä¸»è¦ç±»:**
- `TableDocumentAgent`: è¡¨æ ¼æ–‡æ¡£åˆ†æAgent

**å·¥ä½œæµèŠ‚ç‚¹:**
1. `load_context`: åŠ è½½æ–‡æ¡£ä¸Šä¸‹æ–‡
2. `analyze_query`: åˆ†æç”¨æˆ·æŸ¥è¯¢
3. `execute_query`: æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
4. `format_response`: æ ¼å¼åŒ–å“åº”

## ä½¿ç”¨ç¤ºä¾‹ (Usage Examples)

### ç¤ºä¾‹ 1: æ–‡æ¡£åŠ è½½å’Œæ‘˜è¦

```python
from fiscal_mind.parser import ExcelParser

# åˆ›å»ºè§£æå™¨
parser = ExcelParser()

# åŠ è½½æ–‡æ¡£
doc = parser.load_document('examples/financial_report.xlsx')

# è·å–å·¥ä½œè¡¨åˆ—è¡¨
sheets = doc.get_sheet_names()
print(f"å·¥ä½œè¡¨: {sheets}")

# è·å–æ–‡æ¡£æ‘˜è¦
summary = doc.get_document_summary()
print(summary)
```

### ç¤ºä¾‹ 2: æ•°æ®æœç´¢

```python
# åœ¨æ–‡æ¡£ä¸­æœç´¢å€¼
results = doc.search_value("äº§å“A")
for result in results:
    print(f"æ‰¾åˆ°äº: {result['sheet']}, è¡Œ: {result['row']}, åˆ—: {result['column']}")
```

### ç¤ºä¾‹ 3: ç»Ÿè®¡åˆ†æ

```python
from fiscal_mind.meta_functions import TableMetaFunctions

# è·å–å·¥ä½œè¡¨
df = doc.get_sheet('æŸç›Šè¡¨')

# è·å–æ•°å€¼åˆ—ç»Ÿè®¡
stats = TableMetaFunctions.get_numeric_summary(df)
print(stats)

# è·å–ç‰¹å®šåˆ—ç»Ÿè®¡
col_stats = TableMetaFunctions.get_column_statistics(df, 'å‡€åˆ©æ¶¦')
print(col_stats)
```

### ç¤ºä¾‹ 4: æ•°æ®æŸ¥è¯¢å’Œèšåˆ

```python
from fiscal_mind.meta_functions import TableQueryHelper

# æŒ‰åˆ—èšåˆ
result = TableQueryHelper.aggregate_by_column(
    df, 
    group_col='åŒºåŸŸ', 
    agg_col='é”€å”®é¢', 
    agg_func='sum'
)
print(result)

# è·å–Top N
top_sales = TableQueryHelper.get_top_n_by_column(
    df, 
    column='é”€å”®é¢', 
    n=10
)
print(top_sales)
```

### ç¤ºä¾‹ 5: ä½¿ç”¨Agentè¿›è¡Œæ™ºèƒ½æŸ¥è¯¢

```python
from fiscal_mind.agent import TableDocumentAgent

agent = TableDocumentAgent()
agent.load_documents(['examples/sales_data.xlsx'])

# æ™ºèƒ½æŸ¥è¯¢
response = agent.query("æ˜¾ç¤ºé”€å”®æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯")
print(response)

# åˆ†æç‰¹å®šå·¥ä½œè¡¨
analysis = agent.analyze_sheet('sales_data.xlsx', 'é”€å”®æ˜ç»†')
print(analysis)
```

### ç¤ºä¾‹ 6: å¤šè¡¨æ ¼æ£€æµ‹

```python
from fiscal_mind.parser import ExcelParser

# åˆ›å»ºè§£æå™¨ï¼ˆå¤šè¡¨æ ¼æ£€æµ‹ç°å·²é»˜è®¤å¯ç”¨ï¼‰
parser = ExcelParser()

# åŠ è½½åŒ…å«å¤šä¸ªè¡¨æ ¼çš„æ–‡ä»¶
doc = parser.load_document('examples/multi_table_sheet.xlsx')

# è·å–å·¥ä½œè¡¨æ‘˜è¦
sheet_name = doc.get_sheet_names()[0]
summary = doc.get_sheet_summary(sheet_name)

print(f"æ£€æµ‹åˆ° {summary.get('num_tables', 0)} ä¸ªè¡¨æ ¼")

# è®¿é—®å„ä¸ªè¡¨æ ¼
for i in range(summary.get('num_tables', 0)):
    table_info = doc.get_table_info(sheet_name, i)
    print(f"\nè¡¨æ ¼ {i}:")
    print(f"  æè¿°: {table_info.description}")
    print(f"  ä½ç½®: è¡Œ{table_info.start_row}, åˆ—{table_info.start_col}")
    print(f"  æ•°æ®:\n{table_info.data.head()}")
```

è¯¦è§: [å¤šè¡¨æ ¼æ£€æµ‹æ–‡æ¡£](docs/MULTI_TABLE_DETECTION.md)

### ç¤ºä¾‹ 7: ä½¿ç”¨PRR Agentè¿›è¡Œå¤æ‚åˆ†æ

```python
from fiscal_mind.prr_agent import PRRAgent

# åˆ›å»ºPRR Agent
agent = PRRAgent()

# åŠ è½½åŒºåŸŸä¸šç»©æ•°æ®
agent.load_documents(['examples/regional_performance.xlsx'])

# æé—®ï¼šå“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½ï¼Ÿ
# PRR Agentä¼šè‡ªåŠ¨ï¼š
# 1. Plan - åˆ¶å®šåˆ†æè®¡åˆ’ï¼ˆè¯†åˆ«æ•°æ®ã€æå–æŒ‡æ ‡ã€è®¡ç®—æ±‡æ€»ã€å¯¹æ¯”åˆ†æï¼‰
# 2. ReAct - æ‰§è¡Œæ¨ç†å’Œè¡ŒåŠ¨ï¼ˆè°ƒç”¨å·¥å…·è·å–æ•°æ®ï¼‰
# 3. Reflect - åæ€è¿›åº¦ï¼Œå†³å®šä¸‹ä¸€æ­¥
answer = agent.query("å“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½?")
print(answer)

# è¾“å‡ºç¤ºä¾‹:
# é—®é¢˜: å“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½?
# 
# åˆ†æç»“æœ:
# 1. è¯†åˆ«åŒ…å«åŒºåŸŸ(å¤§åŒº)æ•°æ®çš„å·¥ä½œè¡¨
#    æ‰¾åˆ° 1 ä¸ªæ–‡æ¡£
# 2. æå–å„ä¸ªåŒºåŸŸçš„å…³é”®ä¸šç»©æŒ‡æ ‡(å¦‚é”€å”®é¢ã€åˆ©æ¶¦ç­‰)
#    è·å– 30 æ¡æ•°æ®
# ...
# ç»“è®º: æ ¹æ®åˆ†æï¼Œåä¸œå¤§åŒºè¡¨ç°æœ€ä½³ã€‚

# å¤æ‚å¯¹æ¯”æŸ¥è¯¢
answer = agent.query("å¯¹æ¯”å„å¤§åŒºçš„é”€å”®é¢å’Œåˆ©æ¶¦ç‡ï¼Œæ‰¾å‡ºç»¼åˆè¡¨ç°æœ€å¥½çš„å¤§åŒº")
print(answer)
```

PRRæ¶æ„ç‰¹åˆ«é€‚åˆå›ç­”å¤æ‚çš„è´¢åŠ¡åˆ†æé—®é¢˜:
- "å“ªä¸ªå¤§åŒºä»Šå¹´è¡¨ç°æ›´å¥½ï¼Ÿ"
- "å“ªä¸ªäº§å“çš„åˆ©æ¶¦ç‡æœ€é«˜ï¼Ÿ"
- "é”€å”®é¢å¢é•¿æœ€å¿«çš„æ˜¯å“ªä¸ªåŒºåŸŸï¼Ÿ"

## æ¶æ„è®¾è®¡ (Architecture)

```
FiscalMind/
â”œâ”€â”€ fiscal_mind/
â”‚   â”œâ”€â”€ __init__.py          # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ parser.py            # Excelè§£æå™¨
â”‚   â”œâ”€â”€ meta_functions.py    # å…ƒåŠŸèƒ½å’ŒæŸ¥è¯¢å·¥å…·
â”‚   â”œâ”€â”€ agent.py             # åŸºç¡€LangGraph Agent
â”‚   â”œâ”€â”€ enhanced_agent.py    # å¢å¼ºAgent (Function Calling)
â”‚   â”œâ”€â”€ prr_agent.py         # PRR Agent (Plan-ReAct-Reflect)
â”‚   â”œâ”€â”€ tool_executor.py     # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ tools.py             # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ semantic_resolver.py # è¯­ä¹‰è§£æå™¨
â”‚   â”œâ”€â”€ main.py              # ä¸»ç¨‹åºå…¥å£
â”‚   â””â”€â”€ utils.py             # å·¥å…·å‡½æ•°
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ create_samples.py    # åˆ›å»ºç¤ºä¾‹æ•°æ®
â”‚   â”œâ”€â”€ prr_example.py       # PRR Agentç¤ºä¾‹
â”‚   â””â”€â”€ *.xlsx               # ç¤ºä¾‹Excelæ–‡ä»¶
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_prr_agent.py    # PRR Agentæµ‹è¯•
â”‚   â””â”€â”€ ...                  # å…¶ä»–æµ‹è¯•
â”œâ”€â”€ requirements.txt         # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
```

## Agentå·¥ä½œæµ (Agent Workflow)

### åŸºç¡€Agentå·¥ä½œæµ
```
ç”¨æˆ·æŸ¥è¯¢ (User Query)
    â†“
åŠ è½½ä¸Šä¸‹æ–‡ (Load Context)
    â†“
åˆ†ææŸ¥è¯¢ (Analyze Query)
    â†“
æ‰§è¡ŒæŸ¥è¯¢ (Execute Query)
    â†“
æ ¼å¼åŒ–å“åº” (Format Response)
    â†“
è¿”å›ç»“æœ (Return Result)
```

### PRR Agentå·¥ä½œæµ (Plan-ReAct-Reflect)

```
ç”¨æˆ·æŸ¥è¯¢ (User Query)
    â†“
åŠ è½½ä¸Šä¸‹æ–‡ (Load Context)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plan (è®¡åˆ’)                          â”‚
â”‚  - åˆ†ææŸ¥è¯¢æ„å›¾                       â”‚
â”‚  - åˆ†è§£ä¸ºæ‰§è¡Œæ­¥éª¤                     â”‚
â”‚  - è€ƒè™‘ä¹‹å‰çš„åæ€ï¼ˆå¦‚éœ€é‡æ–°è§„åˆ’ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ReAct (æ¨ç†-è¡ŒåŠ¨)                    â”‚
â”‚  - Reasoning: æ€è€ƒå½“å‰æ­¥éª¤éœ€è¦ä»€ä¹ˆ    â”‚
â”‚  - Acting: è°ƒç”¨å·¥å…·æ‰§è¡Œè¡ŒåŠ¨          â”‚
â”‚  - Observation: è®°å½•æ‰§è¡Œç»“æœ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reflect (åæ€)                       â”‚
â”‚  - è¯„ä¼°æ‰§è¡Œè¿›åº¦                       â”‚
â”‚  - åˆ†æç»“æœè´¨é‡                       â”‚
â”‚  - å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    å†³ç­– â”€â”€â†’ ç»§ç»­ä¸‹ä¸€æ­¥ï¼Ÿ â”€â”€Yesâ”€â”€â†’ è¿”å›ReAct
    â”‚
    No (å®Œæˆ/éœ€é‡æ–°è§„åˆ’)
    â†“
    ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
    â†“
è¿”å›ç»“æœ (Return Result)
```

**PRRæ¶æ„ä¼˜åŠ¿**:
- ğŸ“‹ **æ™ºèƒ½è§„åˆ’**: è‡ªåŠ¨å°†"å“ªä¸ªå¤§åŒºè¡¨ç°æ›´å¥½"åˆ†è§£ä¸ºå…·ä½“æ­¥éª¤
- ğŸ”„ **è¿­ä»£æ‰§è¡Œ**: é€šè¿‡å¤šè½®ReActå¾ªç¯è·å–å’Œåˆ†ææ•°æ®
- ğŸ¤” **è‡ªæˆ‘åæ€**: è¯„ä¼°è¿›åº¦ï¼Œå‘ç°é—®é¢˜æ—¶è‡ªåŠ¨è°ƒæ•´ç­–ç•¥
- ğŸ¯ **ç›®æ ‡å¯¼å‘**: æŒç»­ä¼˜åŒ–ç›´åˆ°è·å¾—æ»¡æ„ç­”æ¡ˆ

## æ‰©å±•å¼€å‘ (Extension Development)

### æ·»åŠ æ–°çš„æŸ¥è¯¢ç±»å‹

åœ¨ `agent.py` ä¸­çš„ `_analyze_query_node` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æŸ¥è¯¢ç±»å‹è¯†åˆ«é€»è¾‘ã€‚

### é›†æˆLLM

FiscalMindæ”¯æŒé›†æˆå„ç§LLMæä¾›å•†ï¼š

```python
from langchain_openai import ChatOpenAI

# åœ¨Agentä¸­é›†æˆLLM
llm = ChatOpenAI(model="gpt-4", temperature=0)
# å¯åœ¨æŸ¥è¯¢åˆ†æå’Œå“åº”ç”Ÿæˆä¸­ä½¿ç”¨LLM
```

### æ·»åŠ æ–°çš„å…ƒåŠŸèƒ½

åœ¨ `meta_functions.py` ä¸­æ·»åŠ æ–°çš„é™æ€æ–¹æ³•åˆ° `TableMetaFunctions` æˆ– `TableQueryHelper` ç±»ã€‚

## åç»­å¼€å‘è®¡åˆ’ (Roadmap)

- [ ] é›†æˆå¤§è¯­è¨€æ¨¡å‹è¿›è¡Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢ç†è§£
- [ ] æ”¯æŒæ›´å¤šæ•°æ®æºï¼ˆCSV, JSONç­‰ï¼‰
- [ ] æ·»åŠ æ•°æ®å¯è§†åŒ–åŠŸèƒ½
- [ ] å®ç°å¤æ‚çš„è´¢åŠ¡åˆ†ææ¨¡å‹
- [ ] æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] å¼€å‘Webç•Œé¢
- [ ] æ”¯æŒå¤šè¯­è¨€ï¼ˆä¸­è‹±æ–‡ï¼‰
- [ ] æ·»åŠ æ›´å¤šæ™ºèƒ½ä½“åä½œåŠŸèƒ½

## è´¡çŒ® (Contributing)

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## è®¸å¯è¯ (License)

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## è”ç³»æ–¹å¼ (Contact)

- é¡¹ç›®ä¸»é¡µ: https://github.com/Heng-Bian/FiscalMind
- Issueåé¦ˆ: https://github.com/Heng-Bian/FiscalMind/issues

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä¸ºåˆå§‹ç‰ˆæœ¬ï¼Œä¸“æ³¨äºè¡¨æ ¼è§£æå’Œå…ƒåŠŸèƒ½å®ç°ã€‚åç»­å°†æ·»åŠ æ›´å¤šæ™ºèƒ½ä½“åŠŸèƒ½å’ŒLLMé›†æˆã€‚
